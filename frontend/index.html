<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Glocation - Test</title>
  </head>
  <body>
    <div id="app">
      <div class="linea"></div>

      <div class="contenido">
        <h1>Gestión de Proyectos</h1>
        <button @click="abrirModalCrear" class="boton-principal">
          Nuevo Proyecto
        </button>

        <!-- Modal -->
        <div v-if="mostrarModal" class="modal-overlay">
          <div class="modal">
            <h2>{{ editingId ? "Actualizar Proyecto" : "Crear Proyecto" }}</h2>

            <form @submit.prevent="editingId ? update() : create()">
              <input v-model="form.nombre" placeholder="Nombre" required />
              <input v-model="form.descripcion" placeholder="Descripción" />
              <select v-model="form.estado">
                <option>En progreso</option>
                <option>Finalizado</option>
              </select>

              <input
                type="date"
                v-model="form.fechaInicio"
                placeholder="Fecha inicio" />
              <input
                type="date"
                v-model="form.fechaFin"
                placeholder="Fecha fin" />

              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-top: 15px;
                ">
                <button type="button" @click="cerrarModal" class="btn-cancelar">
                  Cancelar
                </button>
                <button type="submit" class="btn-accion">
                  {{ editingId ? "Actualizar" : "Crear" }}
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="tabla-container">
          <table style="border: #333">
            <tr>
              <th>Nombre</th>
              <th>Descripción</th>
              <th>Estado</th>
              <th>Fecha Inicio</th>
              <th>Fecha Fin</th>
              <th>Acciones</th>
            </tr>
            <tr v-for="p in proyectos" :key="p.id">
              <td>{{ p.nombre }}</td>
              <td>{{ p.descripcion }}</td>
              <td>{{ p.estado }}</td>
              <td>
                {{ p.fechaInicio ? new Date(p.fechaInicio).toLocaleDateString()
                : '' }}
              </td>
              <td>
                {{ p.fechaFin ? new Date(p.fechaFin).toLocaleDateString() : ''
                }}
              </td>
              <td>
                <button @click="edit(p)">Editar</button>
                <button @click="borrar(p.id)">Borrar</button>
              </td>
            </tr>
          </table>
        </div>

        <div
          style="
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
          ">
          <div
            v-if="proyectos.length > 0"
            class="chart-container"
            style="flex: 1 1 250px; text-align: center">
            <h3>Gráfico</h3>
            <canvas id="chart"></canvas>
          </div>

          <div
            v-if="resumen"
            style="flex: 1 1 250px; margin: auto; text-align: center">
            <h3>Resumen IA</h3>
            <pre class="resumen">{{ resumen }}</pre>
          </div>
        </div>
      </div>

      <div class="linea"></div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const { createApp, ref, reactive, onMounted } = Vue;

      createApp({
        setup() {
          const apiBase = location.hostname === "localhost" ? "http://localhost:3000" : "";

          const proyectos = ref([]);
          const form = reactive({
            nombre: "",
            descripcion: "",
            estado: "En progreso",
          });

          let chartInstance = null;
          const resumen = ref("");
          const mostrarModal = ref(false);
          const editingId = ref(null);

          const abrirModalCrear = () => {
            resetForm();
            mostrarModal.value = true;
          };
          const cerrarModal = () => {
            mostrarModal.value = false;
          };

          const fetch = async () => {
            try {
              const r = await axios.get(apiBase + "/proyectos");
              proyectos.value = r.data.sort((a, b) => a.id - b.id);
              updateChart();
              getResumen();
            } catch (e) {
              console.error("Error al obtener proyectos:", e);
            }
          };

          const create = async () => {
            try {
              await axios.post(apiBase + "/proyectos", {
                ...form,
                fechaInicio: form.fechaInicio ? new Date(form.fechaInicio).setDate(new Date(form.fechaInicio).getDate() + 1) : null,
                fechaFin: form.fechaFin ? new Date(form.fechaFin).setDate(new Date(form.fechaFin).getDate() + 1) : null,
              });
              resetForm();
              await fetch();
              cerrarModal()
            } catch (e) {
              console.error(e);
            }
          };

          const update = async () => {
            if (!editingId.value) return;
            try {
              const r = await axios.put(apiBase + "/proyectos/" + editingId.value, {
                ...form,
                fechaInicio: form.fechaInicio ? new Date(form.fechaInicio).setDate(new Date(form.fechaInicio).getDate() + 1) : null,
                fechaFin: form.fechaFin ? new Date(form.fechaFin).setDate(new Date(form.fechaFin).getDate() + 1) : null,
              });

              // Actualizar proyecto en la lista
              const index = proyectos.value.findIndex(p => p.id === editingId.value);
              if (index !== -1) proyectos.value[index] = r.data;

              resetForm();
              updateChart();
              cerrarModal()
            } catch (e) {
              console.error(e);
            }
          };

          const edit = (p) => {
            form.nombre = p.nombre;
            form.descripcion = p.descripcion;
            form.estado = p.estado;

            const formatDate = (fecha) => {
              if (!fecha) return "";
              const d = new Date(fecha);
              d.setDate(d.getDate() - 1);
              return d.toISOString().split("T")[0];
            };

            form.fechaInicio = formatDate(p.fechaInicio);
            form.fechaFin = formatDate(p.fechaFin);

            editingId.value = p.id;
            mostrarModal.value = true;
          };

          const borrar = async (id) => {
            try {
              await axios.delete(apiBase + "/proyectos/" + id);
              await fetch();
            } catch (e) {
              console.error("Error al borrar proyecto:", e);
            }
          };

          const getResumen = async () => {
            try {
              const r = await axios.post(apiBase + "/proyectos/analisis");
              resumen.value =
                r.data.resumen ||
                r.data.sampleResumen ||
                JSON.stringify(r.data);
            } catch (e) {
              console.error("Error al obtener resumen:", e);
            }
          };

          const updateChart = async () => {
            try {
              const r = await axios.get(
                apiBase + "/proyectos/graficos/estadisticas"
              );
              if (!r.data.length) return;

              const labels = r.data.map((x) => x.estado);
              const data = r.data.map((x) => +x.cantidad);
              const colors = ["#a8dadc", "#90be6d"];

              const ctx = document.getElementById("chart")?.getContext("2d");
              if (!ctx) return;

              if (chartInstance) chartInstance.destroy();
              chartInstance = new Chart(ctx, {
                type: "pie",
                data: { labels, datasets: [{ data, backgroundColor: colors }] },
                options: {
                  responsive: true,
                  plugins: { legend: { position: "bottom" } },
                },
              });
            } catch (e) {
              console.error("Error al actualizar gráfico:", e);
            }
          };

          const resetForm = () => {
            form.nombre = "";
            form.descripcion = "";
            form.estado = "En progreso";
            form.fechaInicio = "";
            form.fechaFin = "";
            editingId.value = null;
          };

          onMounted(() => {
            fetch();
          });

          return {
            proyectos,
            form,
            resumen,
            create,
            update,
            edit,
            borrar,
            editingId,
            mostrarModal,
            abrirModalCrear,
            cerrarModal,
          };
        },
      }).mount("#app");
    </script>
    <style>
      body {
        background-color: #545253;
        color: #333333;
        font-family: Arial, sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        text-align: center;
      }

      #app {
        width: 90%;
        max-width: 800px;
      }

      canvas {
        margin-top: 20px;
      }

      .tabla-container {
        max-height: 200px;
        overflow: auto;
        margin: 0 auto;
        width: 80%;
        margin-top: 30px;
        border-radius: 8px;
        background-color: #fff;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        text-align: center;
      }

      th,
      td {
        padding: 10px;
        border: 1px solid #333;
      }

      th {
        background-color: #90be6d;
      }

      button {
        margin: 0 5px;
        padding: 5px 10px;
      }

      .chart-container {
        display: flex;
        flex-direction: column;
        align-items: center;         
        margin: 0px 0;
      }

      #chart {
        margin-top: -10px;
        max-width: 200px;
        max-height: 200px;
      }

      .resumen {
        max-width: 600px;
        overflow-wrap: break-word;
        word-wrap: break-word;
        white-space: pre-wrap;
        margin: 0 auto;
        text-align: center;
      }

      #linea {
        height: 2px;
        width: 100%;
        background-color: #333;
        margin: 20px 0;
      }

      .contenido {
        border: 2px solid #333;
        padding: 20px;
        border-radius: 10px;
        background-color: #fff;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin: 20px auto;
        max-width: 400px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      input,
      select {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s ease;
      }

      input:focus,
      select:focus {
        border-color: #90be6d;
      }

      button {
        background-color: #90be6d;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 6px;
        font-size: 15px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      button:hover {
        background-color: #74a155;
      }

      .boton-principal {
        background-color: #90be6d;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 15px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 20px;
        transition: background-color 0.2s ease;
      }

      .boton-principal:hover {
        background-color: #74a155;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal {
        background: #fff;
        padding: 25px;
        border-radius: 10px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        text-align: center;
      }

      .modal form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .modal input,
      .modal select {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
      }

      .modal input:focus,
      .modal select:focus {
        border-color: #90be6d;
        outline: none;
      }

      .btn-cancelar {
        background-color: #ccc;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
      }

      .btn-accion {
        background-color: #90be6d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
      }
    </style>
  </body>
</html>
